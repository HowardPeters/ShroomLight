<!DOCTYPE html>
<html>
<head>
    <title>Shroomlight</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
    rel="shortcut icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle r='16' cx='16' cy='16' fill='tomato'/%3E%3Ccircle r='10' cx='20' cy='10' fill='orange'/%3E%3Ccircle r='10' cx='10' cy='20' fill='gold'/%3E%3Ccircle r='10' cx='20' cy='20' fill='teal'/%3E%3C/svg%3E"
    >
    <!--
    <link rel="icon" type="image/png" href="favicon.ico">    
    <link rel="stylesheet" type="text/css" href="style.css">-->
    <meta charset="UTF-8">
    
    <style>
        html {
            font-family: Arial, Helvetica, sans-serif;
            display: inline-block;
            text-align: center;
            overflow: hidden;
            overscroll-behavior: none;
        }
        h1 {
            font-size: 1rem;
            color: white;
            margin-top: 10px;
            margin-bottom: 0px;;
        }
        h2 {
            color: white;
            font-size: 1.2rem;
            margin: 10px 0;
        }
        .topnav {
            overflow: hidden;
            background-color: #0A1128;
        }
        body {
            margin: 0;
            background-color: #0A1128;
        }
        .content {
            padding: 10px;
        }
        .card-grid {
            max-width: 800px;
            margin: 0 auto;
            margin-bottom: 10px;
            display: grid;
            grid-gap: 0.5rem;
            grid-template-columns: repeat(auto-fit, minmax(30px, 1fr));
        }
        .main-grid {
            max-width: 360px;
            margin: 0 auto;
            margin-bottom: 10px;
            display: grid;
            grid-gap: 0.5rem;
            grid-template-rows: auto auto;
        }
        .card {
            background-color: black;
            box-shadow: 2px 2px 12px 1px rgba(140,140,140,.5);
        }
        button {
            color: white;
            padding: 4px 8px;
            margin: 0px 2px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            height: 28px;
        }

        .menu {
            float: right;
            margin: 10px 5px;
        }

        .onButton{
            background-color: #1b8a94;
        }

        .offButton{
            background-color: #5f6c6d;
        }

        .testButton{
            background-color: #38198f;
        }

        .connectButton{
            background-color: #24af37;
        }

        .disconnectButton{
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 333334 333334' width='24px' fill-rule='evenodd' %3E%3Cpath d='M153552 133653V75938l69486 54894-38079 34878 38079 35856-70083 55219 651-60916-29508 28858-13344-12693 42798-39978v-14266l-42526-39652 13343-13615 29183 29183v-54zM166667 0c46023 0 87690 18656 117850 48817 30161 30160 48817 71828 48817 117850 0 46023-18656 87690-48817 117850-30160 30161-71828 48817-117850 48817-46023 0-87690-18656-117850-48817C18656 254357 0 212689 0 166667c0-46023 18656-87690 48817-117850C78977 18656 120645 0 166667 0zm100919 65748c-25826-25826-61507-41802-100919-41802S91574 39921 65748 65748c-25826 25826-41802 61507-41802 100919s15975 75093 41802 100919c25826 25826 61507 41802 100919 41802s75093-15975 100919-41802c25826-25826 41802-61507 41802-100919s-15975-75093-41802-100919zm-95374 48812l19690 16544-19690 15839v-32383zm0 70733l19690 16544-19690 15839v-32383z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-color: #d13a30;
            width: 34px;
        }

        .settingsButton{
            background-image: url("data:image/svg+xml,%3Csvg id='Layer_1' data-name='Layer 1' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120' width='24px' fill='white'%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill-rule:evenodd;%7D%3C/style%3E%3C/defs%3E%3Ctitle%3Egear%3C/title%3E%3Cpath class='cls-1' d='M73.48,15.84A46.87,46.87,0,0,1,84.87,21L91,14.84a7.6,7.6,0,0,1,10.72,0L108,21.15a7.6,7.6,0,0,1,0,10.72l-6.6,6.6a46.6,46.6,0,0,1,4.34,10.93h9.52A7.6,7.6,0,0,1,122.88,57V65.9a7.6,7.6,0,0,1-7.58,7.58h-9.61a46.83,46.83,0,0,1-4.37,10.81L108,91a7.6,7.6,0,0,1,0,10.72L101.73,108A7.61,7.61,0,0,1,91,108l-6.34-6.35a47.22,47.22,0,0,1-11.19,5v8.59a7.6,7.6,0,0,1-7.58,7.58H57a7.6,7.6,0,0,1-7.58-7.58v-7.76a47.39,47.39,0,0,1-12.35-4.68L31.87,108a7.62,7.62,0,0,1-10.72,0l-6.31-6.31a7.61,7.61,0,0,1,0-10.72l4.72-4.72A47.38,47.38,0,0,1,14,73.48H7.58A7.6,7.6,0,0,1,0,65.9V57A7.6,7.6,0,0,1,7.58,49.4h6.35a47.2,47.2,0,0,1,5.51-12.94l-4.6-4.59a7.62,7.62,0,0,1,0-10.72l6.31-6.31a7.6,7.6,0,0,1,10.72,0l5,5A46.6,46.6,0,0,1,49.4,15V7.58A7.6,7.6,0,0,1,57,0H65.9a7.6,7.6,0,0,1,7.58,7.58v8.26ZM59.86,36.68a24.6,24.6,0,1,1-24.6,24.59,24.59,24.59,0,0,1,24.6-24.59Z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-color: rgb(82, 81, 81);
            width: 34px;
        }

        .reloadButton{
            background-image: url("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3Csvg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 122.04 122.88' width='24px' fill='white' style='enable-background:new 0 0 122.04 122.88' xml:space='preserve'%3E%3Cstyle type='text/css'%3E.st0%7Bfill-rule:evenodd;clip-rule:evenodd;%7D%3C/style%3E%3Cg%3E%3Cpath class='st0' d='M117.31,9.3v39.28H78.03l-4.63,0l3.27-3.28l11.45-11.45c-0.75-0.73-1.54-1.44-2.36-2.11 c-1.08-0.88-2.22-1.72-3.38-2.48l0,0c-6.02-3.93-13.21-6.21-20.94-6.21l-0.01,0v-0.01c-10.59,0-20.18,4.3-27.12,11.24 c-6.94,6.94-11.24,16.53-11.24,27.11h0.01v0.05h-0.01c0,10.59,4.3,20.19,11.24,27.12c6.94,6.94,16.53,11.24,27.11,11.24v-0.01 l0.08,0v0.01c3.7,0,7.39-0.54,10.93-1.59v0c1.95-0.58,3.87-1.33,5.71-2.22c9.39-4.54,16.65-12.8,19.87-22.87l0.43-1.33l23.61,0 l-0.47,2.3l-0.01,0.06v0.01c-0.81,3.84-2.01,7.62-3.54,11.24v0.01c-1.5,3.55-3.37,6.98-5.52,10.19 c-11.02,16.43-29.78,27.26-51.05,27.26h-0.02v-0.01c-16.96,0-32.33-6.88-43.43-17.99v-0.01C6.89,93.77,0.02,78.42,0.01,61.47 l-0.01,0v-0.05l0.01,0c0-16.96,6.88-32.32,18-43.43l0,0C29.11,6.89,44.46,0.02,61.41,0.01V0l0.06,0v0.01 c8.71,0,17.01,1.83,24.51,5.1c1.21,0.53,2.43,1.1,3.6,1.71c5.48,2.83,10.47,6.46,14.83,10.74l9.61-9.61l3.27-3.27V9.3L117.31,9.3 L117.31,9.3z'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-color: rgb(82, 81, 81);
            width: 34px;
        }

        .logButton{
            background-color: #723002;
        }

        .homeButton{
            background-image: url("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3Csvg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 122.88 112.07' width='24px' fill='white'  style='enable-background:new 0 0 122.88 112.07' xml:space='preserve'%3E%3Cstyle type='text/css'%3E.st0%7Bfill-rule:evenodd;clip-rule:evenodd;%7D%3C/style%3E%3Cg%3E%3Cpath class='st0' d='M61.44,0L0,60.18l14.99,7.87L61.04,19.7l46.85,48.36l14.99-7.87L61.44,0L61.44,0z M18.26,69.63L18.26,69.63 L61.5,26.38l43.11,43.25h0v0v42.43H73.12V82.09H49.49v29.97H18.26V69.63L18.26,69.63L18.26,69.63z'/%3E%3C/g%3E%3C/svg%3E");
            background-color: blue;
            background-repeat: no-repeat;
            background-position: center;
            width: 34px;
        }

        .gray-label {
            color: #bebebe;
            font-size: 1rem;
            margin: 8px;
        }

        .log-label {
            color: #bebebe;
            font-size: 1rem;
        }

        .small-label {
            color: #bebebe;
            font-size: 0.8rem;
        }

        .reading {
            font-size: 1rem;
            color: white;
            text-align: right;
            display: inline-block;
            min-width: 70px;
            margin: 5px 0 0 0;
        }
        .sliderback {
        background-color: black;
        padding: 10px;
        
        }
        .slider {
            background-color: #4c00ff;
            mask-image: linear-gradient(90deg, transparent, rgb(0 0 0 / 100%), transparent);
            width: 200px;
            height: 50px;
            margin: auto;
        }

        .knob {
            position: relative;
            display: inline-block;
            width: 25px;
            height: 50px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cline x1='13' y1='0' x2='13' y2='50' style='stroke:%234b4a4a;stroke-opacity:0.5;stroke-width:20' /%3E%3Cline x1='13' y1='0' x2='13' y2='50' style='stroke:%239e9d9d;stroke-opacity:0.5;stroke-width:15' /%3E%3Cline x1='13' y1='0' x2='13' y2='50' style='stroke:white;stroke-width:5' /%3E%3C/svg%3E");
        }
        .knobblock {
            position: relative;
            left: 0px; 
            width: 250px;
        }
        .level {
            width: 80%;
            height: 25px;
            margin: 0px;
        }
        .numberBox {
            display: inline-block;
            margin: 0 5px;
            width: 25px;
        }
        .colourBox {
            display: inline-block;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            margin: 10px;
            background-color: #bebebe;
        }
        .box-grid {
            margin: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(30px, 1fr));
        }
        .cp-grid {
            margin: auto;
            display: grid;
            grid-template-columns: 270px 50px;
        }
        .fader {
            appearance: none;
            writing-mode: vertical-lr; 
            direction: rtl;
            margin-top: 10px;
            width: 30%;
            height: 230px;
            border-radius: 20px;
            background-color: #5f6c6d;
        }    
        .fader::-webkit-slider-thumb {
            cursor: pointer; /* Cursor on hover */
            -webkit-appearance: none;
            border-radius: 20px;
            width: 30px;
            height: 15px;
            background-color:blue;

        }
        .statusBar {
            margin: 10px;
        }
        .log-device {
            color: white;
            font-size: 0.9rem;
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .log-item {
            display: inline-block;
            margin: 0 5px;
            padding: 0 2px;
            width: 20px;
            text-align: right;
        }
        .log-name {
            display: inline-block;
            margin: 0 5px;
            width: 130px;
            text-align: left;
        }
        .log-listitem {
            background-color: #080860;
            margin: 3px 0;
        }
        .log-listitem-Selected {
            background-color: darkmagenta;
            margin: 5px 0;
        }
        .chartCanvas {
            border:1px solid grey; 
            background-color:#0A1128; 
            margin: auto;
        }

</style>
    <!--<script src="file:///C:/Users/HowardP/Documents/PlatformIO/Projects/ESP32S3%20test/test/iro_min.js"></script>-->
    <script>
        !function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t=t||self).iro=n()}(this,function(){"use strict";var m,s,n,i,o,x={},j=[],r=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|^--/i;function M(t,n){for(var i in n)t[i]=n[i];return t}function y(t){var n=t.parentNode;n&&n.removeChild(t)}function h(t,n,i){var r,e,u,o,l=arguments;if(n=M({},n),3<arguments.length)for(i=[i],r=3;r<arguments.length;r++)i.push(l[r]);if(null!=i&&(n.children=i),null!=t&&null!=t.defaultProps)for(e in t.defaultProps)void 0===n[e]&&(n[e]=t.defaultProps[e]);return o=n.key,null!=(u=n.ref)&&delete n.ref,null!=o&&delete n.key,c(t,n,o,u)}function c(t,n,i,r){var e={type:t,props:n,key:i,ref:r,n:null,i:null,e:0,o:null,l:null,c:null,constructor:void 0};return m.vnode&&m.vnode(e),e}function O(t){return t.children}function I(t,n){this.props=t,this.context=n}function w(t,n){if(null==n)return t.i?w(t.i,t.i.n.indexOf(t)+1):null;for(var i;n<t.n.length;n++)if(null!=(i=t.n[n])&&null!=i.o)return i.o;return"function"==typeof t.type?w(t):null}function a(t){var n,i;if(null!=(t=t.i)&&null!=t.c){for(t.o=t.c.base=null,n=0;n<t.n.length;n++)if(null!=(i=t.n[n])&&null!=i.o){t.o=t.c.base=i.o;break}return a(t)}}function e(t){(!t.f&&(t.f=!0)&&1===s.push(t)||i!==m.debounceRendering)&&(i=m.debounceRendering,(m.debounceRendering||n)(u))}function u(){var t,n,i,r,e,u,o,l;for(s.sort(function(t,n){return n.d.e-t.d.e});t=s.pop();)t.f&&(r=i=void 0,u=(e=(n=t).d).o,o=n.p,l=n.u,n.u=!1,o&&(i=[],r=k(o,e,M({},e),n.w,void 0!==o.ownerSVGElement,null,i,l,null==u?w(e):u),d(i,e),r!=u&&a(e)))}function S(n,i,t,r,e,u,o,l,s){var c,a,f,h,v,d,g,b=t&&t.n||j,p=b.length;if(l==x&&(l=null!=u?u[0]:p?w(t,0):null),c=0,i.n=A(i.n,function(t){if(null!=t){if(t.i=i,t.e=i.e+1,null===(f=b[c])||f&&t.key==f.key&&t.type===f.type)b[c]=void 0;else for(a=0;a<p;a++){if((f=b[a])&&t.key==f.key&&t.type===f.type){b[a]=void 0;break}f=null}if(h=k(n,t,f=f||x,r,e,u,o,null,l,s),(a=t.ref)&&f.ref!=a&&(g=g||[]).push(a,t.c||h,t),null!=h){if(null==d&&(d=h),null!=t.l)h=t.l,t.l=null;else if(u==f||h!=l||null==h.parentNode){t:if(null==l||l.parentNode!==n)n.appendChild(h);else{for(v=l,a=0;(v=v.nextSibling)&&a<p;a+=2)if(v==h)break t;n.insertBefore(h,l)}"option"==i.type&&(n.value="")}l=h.nextSibling,"function"==typeof i.type&&(i.l=h)}}return c++,t}),i.o=d,null!=u&&"function"!=typeof i.type)for(c=u.length;c--;)null!=u[c]&&y(u[c]);for(c=p;c--;)null!=b[c]&&N(b[c],b[c]);if(g)for(c=0;c<g.length;c++)E(g[c],g[++c],g[++c])}function A(t,n,i){if(null==i&&(i=[]),null==t||"boolean"==typeof t)n&&i.push(n(null));else if(Array.isArray(t))for(var r=0;r<t.length;r++)A(t[r],n,i);else i.push(n?n(function(t){if(null==t||"boolean"==typeof t)return null;if("string"==typeof t||"number"==typeof t)return c(null,t,null,null);if(null==t.o&&null==t.c)return t;var n=c(t.type,t.props,t.key,null);return n.o=t.o,n}(t)):t);return i}function f(t,n,i){"-"===n[0]?t.setProperty(n,i):t[n]="number"==typeof i&&!1===r.test(n)?i+"px":null==i?"":i}function R(t,n,i,r,e){var u,o,l,s,c;if("key"===(n=e?"className"===n?"class":n:"class"===n?"className":n)||"children"===n);else if("style"===n)if(u=t.style,"string"==typeof i)u.cssText=i;else{if("string"==typeof r&&(u.cssText="",r=null),r)for(o in r)i&&o in i||f(u,o,"");if(i)for(l in i)r&&i[l]===r[l]||f(u,l,i[l])}else"o"===n[0]&&"n"===n[1]?(s=n!==(n=n.replace(/Capture$/,"")),n=((c=n.toLowerCase())in t?c:n).slice(2),i?(r||t.addEventListener(n,v,s),(t.t||(t.t={}))[n]=i):t.removeEventListener(n,v,s)):"list"!==n&&"tagName"!==n&&"form"!==n&&!e&&n in t?t[n]=null==i?"":i:"function"!=typeof i&&"dangerouslySetInnerHTML"!==n&&(n!==(n=n.replace(/^xlink:?/,""))?null==i||!1===i?t.removeAttributeNS("http://www.w3.org/1999/xlink",n.toLowerCase()):t.setAttributeNS("http://www.w3.org/1999/xlink",n.toLowerCase(),i):null==i||!1===i?t.removeAttribute(n):t.setAttribute(n,i))}function v(t){return this.t[t.type](m.event?m.event(t):t)}function k(t,n,i,r,e,u,o,l,s,c){var a,f,h,v,d,g,b,p,y,w,k=n.type;if(void 0!==n.constructor)return null;(a=m.e)&&a(n);try{t:if("function"==typeof k){if(p=n.props,y=(a=k.contextType)&&r[a.c],w=a?y?y.props.value:a.i:r,i.c?b=(f=n.c=i.c).i=f.k:("prototype"in k&&k.prototype.render?n.c=f=new k(p,w):(n.c=f=new I(p,w),f.constructor=k,f.render=z),y&&y.sub(f),f.props=p,f.state||(f.state={}),f.context=w,f.w=r,h=f.f=!0,f.m=[]),null==f.j&&(f.j=f.state),null!=k.getDerivedStateFromProps&&M(f.j==f.state?f.j=M({},f.j):f.j,k.getDerivedStateFromProps(p,f.j)),h)null==k.getDerivedStateFromProps&&null!=f.componentWillMount&&f.componentWillMount(),null!=f.componentDidMount&&o.push(f);else{if(null==k.getDerivedStateFromProps&&null==l&&null!=f.componentWillReceiveProps&&f.componentWillReceiveProps(p,w),!l&&null!=f.shouldComponentUpdate&&!1===f.shouldComponentUpdate(p,f.j,w)){for(f.props=p,f.state=f.j,f.f=!1,(f.d=n).o=null!=s?s!==i.o?s:i.o:null,n.n=i.n,a=0;a<n.n.length;a++)n.n[a]&&(n.n[a].i=n);break t}null!=f.componentWillUpdate&&f.componentWillUpdate(p,f.j,w)}for(v=f.props,d=f.state,f.context=w,f.props=p,f.state=f.j,(a=m.M)&&a(n),f.f=!1,f.d=n,f.p=t,a=f.render(f.props,f.state,f.context),n.n=A(null!=a&&a.type==O&&null==a.key?a.props.children:a),null!=f.getChildContext&&(r=M(M({},r),f.getChildContext())),h||null==f.getSnapshotBeforeUpdate||(g=f.getSnapshotBeforeUpdate(v,d)),S(t,n,i,r,e,u,o,s,c),f.base=n.o;a=f.m.pop();)f.j&&(f.state=f.j),a.call(f);h||null==v||null==f.componentDidUpdate||f.componentDidUpdate(v,d,g),b&&(f.k=f.i=null)}else n.o=function(t,n,i,r,e,u,o,l){var s,c,a,f,h=i.props,v=n.props;if(e="svg"===n.type||e,null==t&&null!=u)for(s=0;s<u.length;s++)if(null!=(c=u[s])&&(null===n.type?3===c.nodeType:c.localName===n.type)){t=c,u[s]=null;break}if(null==t){if(null===n.type)return document.createTextNode(v);t=e?document.createElementNS("http://www.w3.org/2000/svg",n.type):document.createElement(n.type),u=null}return null===n.type?h!==v&&(null!=u&&(u[u.indexOf(t)]=null),t.data=v):n!==i&&(null!=u&&(u=j.slice.call(t.childNodes)),a=(h=i.props||x).dangerouslySetInnerHTML,f=v.dangerouslySetInnerHTML,l||(f||a)&&(f&&a&&f.O==a.O||(t.innerHTML=f&&f.O||"")),function(t,n,i,r,e){var u;for(u in i)u in n||R(t,u,null,i[u],r);for(u in n)e&&"function"!=typeof n[u]||"value"===u||"checked"===u||i[u]===n[u]||R(t,u,n[u],i[u],r)}(t,v,h,e,l),n.n=n.props.children,f||S(t,n,i,r,"foreignObject"!==n.type&&e,u,o,x,l),l||("value"in v&&void 0!==v.value&&v.value!==t.value&&(t.value=null==v.value?"":v.value),"checked"in v&&void 0!==v.checked&&v.checked!==t.checked&&(t.checked=v.checked))),t}(i.o,n,i,r,e,u,o,c);(a=m.diffed)&&a(n)}catch(t){m.o(t,n,i)}return n.o}function d(t,n){for(var i;i=t.pop();)try{i.componentDidMount()}catch(t){m.o(t,i.d)}m.c&&m.c(n)}function E(t,n,i){try{"function"==typeof t?t(n):t.current=n}catch(t){m.o(t,i)}}function N(t,n,i){var r,e,u;if(m.unmount&&m.unmount(t),(r=t.ref)&&E(r,null,n),i||"function"==typeof t.type||(i=null!=(e=t.o)),t.o=t.l=null,null!=(r=t.c)){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(t){m.o(t,n)}r.base=r.p=null}if(r=t.n)for(u=0;u<r.length;u++)r[u]&&N(r[u],n,i);null!=e&&y(e)}function z(t,n,i){return this.constructor(t,i)}function g(t,n){for(var i=0;i<n.length;i++){var r=n[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function b(){return(b=Object.assign||function(t){for(var n=arguments,i=1;i<arguments.length;i++){var r=n[i];for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])}return t}).apply(this,arguments)}m={},I.prototype.setState=function(t,n){var i=this.j!==this.state&&this.j||(this.j=M({},this.state));"function"==typeof t&&!(t=t(i,this.props))||M(i,t),null!=t&&this.d&&(this.u=!1,n&&this.m.push(n),e(this))},I.prototype.forceUpdate=function(t){this.d&&(t&&this.m.push(t),this.u=!0,e(this))},I.prototype.render=O,s=[],n="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,i=m.debounceRendering,m.o=function(t,n,i){for(var r;n=n.i;)if((r=n.c)&&!r.i)try{if(r.constructor&&null!=r.constructor.getDerivedStateFromError)r.setState(r.constructor.getDerivedStateFromError(t));else{if(null==r.componentDidCatch)continue;r.componentDidCatch(t)}return e(r.k=r)}catch(n){t=n}throw t},o=x;var t="(?:[-\\+]?\\d*\\.\\d+%?)|(?:[-\\+]?\\d+%?)",l="[\\s|\\(]+("+t+")[,|\\s]+("+t+")[,|\\s]+("+t+")\\s*\\)?",p="[\\s|\\(]+("+t+")[,|\\s]+("+t+")[,|\\s]+("+t+")[,|\\s]+("+t+")\\s*\\)?",_=new RegExp("rgb"+l),H=new RegExp("rgba"+p),P=new RegExp("hsl"+l),$=new RegExp("hsla"+p),T="^(?:#?|0x?)",W="([0-9a-fA-F]{1})",C="([0-9a-fA-F]{2})",D=new RegExp(T+W+W+W+"$"),F=new RegExp(T+W+W+W+W+"$"),L=new RegExp(T+C+C+C+"$"),B=new RegExp(T+C+C+C+C+"$"),q=Math.log,G=Math.round,Z=Math.floor;function J(t,n,i){return Math.min(Math.max(t,n),i)}function K(t,n){var i=-1<t.indexOf("%"),r=parseFloat(t);return i?n/100*r:r}function Q(t){return parseInt(t,16)}function U(t){return t.toString(16).padStart(2,"0")}var V=function(){function l(t,n){this.$={h:0,s:0,v:0,a:1},t&&this.set(t),this.onChange=n,this.initialValue=b({},this.$)}var t=l.prototype;return t.set=function(t){if("string"==typeof t)/^(?:#?|0x?)[0-9a-fA-F]{3,8}$/.test(t)?this.hexString=t:/^rgba?/.test(t)?this.rgbString=t:/^hsla?/.test(t)&&(this.hslString=t);else{if("object"!=typeof t)throw new Error("Invalid color value");t instanceof l?this.hsva=t.hsva:"r"in t&&"g"in t&&"b"in t?this.rgb=t:"h"in t&&"s"in t&&"v"in t?this.hsv=t:"h"in t&&"s"in t&&"l"in t?this.hsl=t:"kelvin"in t&&(this.kelvin=t.kelvin)}},t.setChannel=function(t,n,i){var r;this[t]=b({},this[t],((r={})[n]=i,r))},t.reset=function(){this.hsva=this.initialValue},t.clone=function(){return new l(this)},t.unbind=function(){this.onChange=void 0},l.hsvToRgb=function(t){var n=t.h/60,i=t.s/100,r=t.v/100,e=Z(n),u=n-e,o=r*(1-i),l=r*(1-u*i),s=r*(1-(1-u)*i),c=e%6,a=[s,r,r,l,o,o][c],f=[o,o,s,r,r,l][c];return{r:J(255*[r,l,o,o,s,r][c],0,255),g:J(255*a,0,255),b:J(255*f,0,255)}},l.rgbToHsv=function(t){var n=t.r/255,i=t.g/255,r=t.b/255,e=Math.max(n,i,r),u=Math.min(n,i,r),o=e-u,l=0,s=e,c=0===e?0:o/e;switch(e){case u:l=0;break;case n:l=(i-r)/o+(i<r?6:0);break;case i:l=(r-n)/o+2;break;case r:l=(n-i)/o+4}return{h:60*l%360,s:J(100*c,0,100),v:J(100*s,0,100)}},l.hsvToHsl=function(t){var n=t.s/100,i=t.v/100,r=(2-n)*i,e=r<=1?r:2-r,u=e<1e-9?0:n*i/e;return{h:t.h,s:J(100*u,0,100),l:J(50*r,0,100)}},l.hslToHsv=function(t){var n=2*t.l,i=t.s*(n<=100?n:200-n)/100,r=n+i<1e-9?0:2*i/(n+i);return{h:t.h,s:J(100*r,0,100),v:J((n+i)/2,0,100)}},l.kelvinToRgb=function(t){var n,i,r,e=t/100;return r=e<66?(n=255,i=-155.25485562709179-.44596950469579133*(i=e-2)+104.49216199393888*q(i),e<20?0:.8274096064007395*(r=e-10)-254.76935184120902+115.67994401066147*q(r)):(n=351.97690566805693+.114206453784165*(n=e-55)-40.25366309332127*q(n),i=325.4494125711974+.07943456536662342*(i=e-50)-28.0852963507957*q(i),255),{r:J(Z(n),0,255),g:J(Z(i),0,255),b:J(Z(r),0,255)}},l.rgbToKelvin=function(t){for(var n,i=t.r,r=t.b,e=2e3,u=4e4;.4<u-e;){var o=l.kelvinToRgb(n=.5*(u+e));o.b/o.r>=r/i?u=n:e=n}return n},function(t,n,i){n&&g(t.prototype,n),i&&g(t,i)}(l,[{key:"hsv",get:function(){var t=this.$;return{h:t.h,s:t.s,v:t.v}},set:function(t){var n=this.$;if(t=b({},n,t),this.onChange){var i={h:!1,v:!1,s:!1,a:!1};for(var r in n)i[r]=t[r]!=n[r];this.$=t,(i.h||i.s||i.v||i.a)&&this.onChange(this,i)}else this.$=t}},{key:"hsva",get:function(){return b({},this.$)},set:function(t){this.hsv=t}},{key:"hue",get:function(){return this.$.h},set:function(t){this.hsv={h:t}}},{key:"saturation",get:function(){return this.$.s},set:function(t){this.hsv={s:t}}},{key:"value",get:function(){return this.$.v},set:function(t){this.hsv={v:t}}},{key:"alpha",get:function(){return this.$.a},set:function(t){this.hsv=b({},this.hsv,{a:t})}},{key:"kelvin",get:function(){return l.rgbToKelvin(this.rgb)},set:function(t){this.rgb=l.kelvinToRgb(t)}},{key:"red",get:function(){return this.rgb.r},set:function(t){this.rgb=b({},this.rgb,{r:t})}},{key:"green",get:function(){return this.rgb.g},set:function(t){this.rgb=b({},this.rgb,{g:t})}},{key:"blue",get:function(){return this.rgb.b},set:function(t){this.rgb=b({},this.rgb,{b:t})}},{key:"rgb",get:function(){var t=l.hsvToRgb(this.$),n=t.r,i=t.g,r=t.b;return{r:G(n),g:G(i),b:G(r)}},set:function(t){this.hsv=b({},l.rgbToHsv(t),{a:void 0===t.a?1:t.a})}},{key:"rgba",get:function(){return b({},this.rgb,{a:this.alpha})},set:function(t){this.rgb=t}},{key:"hsl",get:function(){var t=l.hsvToHsl(this.$),n=t.h,i=t.s,r=t.l;return{h:G(n),s:G(i),l:G(r)}},set:function(t){this.hsv=b({},l.hslToHsv(t),{a:void 0===t.a?1:t.a})}},{key:"hsla",get:function(){return b({},this.hsl,{a:this.alpha})},set:function(t){this.hsl=t}},{key:"rgbString",get:function(){var t=this.rgb;return"rgb("+t.r+", "+t.g+", "+t.b+")"},set:function(t){var n,i,r,e,u=1;if((n=_.exec(t))?(i=K(n[1],255),r=K(n[2],255),e=K(n[3],255)):(n=H.exec(t))&&(i=K(n[1],255),r=K(n[2],255),e=K(n[3],255),u=K(n[4],1)),!n)throw new Error("Invalid rgb string");this.rgb={r:i,g:r,b:e,a:u}}},{key:"rgbaString",get:function(){var t=this.rgba;return"rgba("+t.r+", "+t.g+", "+t.b+", "+t.a+")"},set:function(t){this.rgbString=t}},{key:"hexString",get:function(){var t=this.rgb;return"#"+U(t.r)+U(t.g)+U(t.b)},set:function(t){var n,i,r,e,u=255;if((n=D.exec(t))?(i=17*Q(n[1]),r=17*Q(n[2]),e=17*Q(n[3])):(n=F.exec(t))?(i=17*Q(n[1]),r=17*Q(n[2]),e=17*Q(n[3]),u=17*Q(n[4])):(n=L.exec(t))?(i=Q(n[1]),r=Q(n[2]),e=Q(n[3])):(n=B.exec(t))&&(i=Q(n[1]),r=Q(n[2]),e=Q(n[3]),u=Q(n[4])),!n)throw new Error("Invalid hex string");this.rgb={r:i,g:r,b:e,a:u/255}}},{key:"hex8String",get:function(){var t=this.rgba;return"#"+U(t.r)+U(t.g)+U(t.b)+U(Z(255*t.a))},set:function(t){this.hexString=t}},{key:"hslString",get:function(){var t=this.hsl;return"hsl("+t.h+", "+t.s+"%, "+t.l+"%)"},set:function(t){var n,i,r,e,u=1;if((n=P.exec(t))?(i=K(n[1],360),r=K(n[2],100),e=K(n[3],100)):(n=$.exec(t))&&(i=K(n[1],360),r=K(n[2],100),e=K(n[3],100),u=K(n[4],1)),!n)throw new Error("Invalid hsl string");this.hsl={h:i,s:r,l:e,a:u}}},{key:"hslaString",get:function(){var t=this.hsla;return"hsla("+t.h+", "+t.s+"%, "+t.l+"%, "+t.a+")"},set:function(t){this.hslString=t}}]),l}();function X(t){var n,i=t.width,r=t.sliderSize,e=t.borderWidth,u=t.handleRadius,o=t.padding,l=t.sliderShape,s="horizontal"===t.layoutDirection;return r=null!=(n=r)?n:2*o+2*u,"circle"===l?{handleStart:t.padding+t.handleRadius,handleRange:i-2*o-2*u,width:i,height:i,cx:i/2,cy:i/2,radius:i/2-e/2}:{handleStart:r/2,handleRange:i-r,radius:r/2,x:0,y:0,width:s?r:i,height:s?i:r}}function Y(t,n){var i=X(t),r=i.width,e=i.height,u=i.handleRange,o=i.handleStart,l="horizontal"===t.layoutDirection,s=l?r/2:e/2,c=o+function(t,n){var i=n.hsva,r=n.rgb;switch(t.sliderType){case"red":return r.r/2.55;case"green":return r.g/2.55;case"blue":return r.b/2.55;case"alpha":return 100*i.a;case"kelvin":var e=t.minTemperature,u=t.maxTemperature-e,o=(n.kelvin-e)/u*100;return Math.max(0,Math.min(o,100));case"hue":return i.h/=3.6;case"saturation":return i.s;case"value":default:return i.v}}(t,n)/100*u;return l&&(c=-1*c+u+2*o),{x:l?s:c,y:l?c:s}}var tt,nt=2*Math.PI,it=function(t,n){return(t%n+n)%n},rt=function(t,n){return Math.sqrt(t*t+n*n)};function et(t){return t.width/2-t.padding-t.handleRadius-t.borderWidth}function ut(t){var n=t.width/2;return{width:t.width,radius:n-t.borderWidth,cx:n,cy:n}}function ot(t,n,i){var r=t.wheelAngle,e=t.wheelDirection;return i&&"clockwise"===e?n=r+n:"clockwise"===e?n=360-r+n:i&&"anticlockwise"===e?n=r+180-n:"anticlockwise"===e&&(n=r-n),it(n,360)}function lt(t,n,i){var r=ut(t),e=r.cx,u=r.cy,o=et(t);n=e-n,i=u-i;var l=ot(t,Math.atan2(-i,-n)*(360/nt)),s=Math.min(rt(n,i),o);return{h:Math.round(l),s:Math.round(100/o*s)}}function st(t){var n=t.width,i=t.boxHeight;return{width:n,height:null!=i?i:n,radius:t.padding+t.handleRadius}}function ct(t,n,i){var r=st(t),e=r.width,u=r.height,o=r.radius,l=(n-o)/(e-2*o)*100,s=(i-o)/(u-2*o)*100;return{s:Math.max(0,Math.min(l,100)),v:Math.max(0,Math.min(100-s,100))}}function at(t,n,i,r){for(var e=0;e<r.length;e++){var u=r[e].x-n,o=r[e].y-i;if(Math.sqrt(u*u+o*o)<t.handleRadius)return e}return null}function ft(t){return{boxSizing:"border-box",border:t.borderWidth+"px solid "+t.borderColor}}function ht(t,n,i){return t+"-gradient("+n+", "+i.map(function(t){var n=t[0];return t[1]+" "+n+"%"}).join(",")+")"}function vt(t){return"string"==typeof t?t:t+"px"}var dt=["mousemove","touchmove","mouseup","touchend"],gt=function(n){function t(t){n.call(this,t),this.uid=(Math.random()+1).toString(36).substring(5)}return n&&(t.__proto__=n),((t.prototype=Object.create(n&&n.prototype)).constructor=t).prototype.render=function(t){var n=this.handleEvent.bind(this),i={onMouseDown:n,ontouchstart:n},r="horizontal"===t.layoutDirection,e=null===t.margin?t.sliderMargin:t.margin,u={overflow:"visible",display:r?"inline-block":"block"};return 0<t.index&&(u[r?"marginLeft":"marginTop"]=e),h(O,null,t.children(this.uid,i,u))},t.prototype.handleEvent=function(t){var n=this,i=this.props.onInput,r=this.base.getBoundingClientRect();t.preventDefault();var e=t.touches?t.changedTouches[0]:t,u=e.clientX-r.left,o=e.clientY-r.top;switch(t.type){case"mousedown":case"touchstart":!1!==i(u,o,0)&&dt.forEach(function(t){document.addEventListener(t,n,{passive:!1})});break;case"mousemove":case"touchmove":i(u,o,1);break;case"mouseup":case"touchend":i(u,o,2),dt.forEach(function(t){document.removeEventListener(t,n,{passive:!1})})}},t}(I);function bt(t){var n=t.r,i=t.url,r=n,e=n;return h("svg",{className:"IroHandle IroHandle--"+t.index+" "+(t.isActive?"IroHandle--isActive":""),style:{"-webkit-tap-highlight-color":"rgba(0, 0, 0, 0);",transform:"translate("+vt(t.x)+", "+vt(t.y)+")",willChange:"transform",top:vt(-n),left:vt(-n),width:vt(2*n),height:vt(2*n),position:"absolute",overflow:"visible"}},i&&h("use",Object.assign({xlinkHref:function(t){tt=tt||document.getElementsByTagName("base");var n=window.navigator.userAgent,i=/^((?!chrome|android).)*safari/i.test(n),r=/iPhone|iPod|iPad/i.test(n),e=window.location;return(i||r)&&0<tt.length?e.protocol+"//"+e.host+e.pathname+e.search+t:t}(i)},t.props)),!i&&h("circle",{cx:r,cy:e,r:n,fill:"none","stroke-width":2,stroke:"#000"}),!i&&h("circle",{cx:r,cy:e,r:n-2,fill:t.fill,"stroke-width":2,stroke:"#fff"}))}function pt(e){var t=e.activeIndex,u=void 0!==t&&t<e.colors.length?e.colors[t]:e.color,n=X(e),r=n.width,o=n.height,l=n.radius,s=Y(e,u),c=function(t,n){var i=n.hsv,r=n.rgb;switch(t.sliderType){case"red":return[[0,"rgb(0,"+r.g+","+r.b+")"],[100,"rgb(255,"+r.g+","+r.b+")"]];case"green":return[[0,"rgb("+r.r+",0,"+r.b+")"],[100,"rgb("+r.r+",255,"+r.b+")"]];case"blue":return[[0,"rgb("+r.r+","+r.g+",0)"],[100,"rgb("+r.r+","+r.g+",255)"]];case"alpha":return[[0,"rgba("+r.r+","+r.g+","+r.b+",0)"],[100,"rgb("+r.r+","+r.g+","+r.b+")"]];case"kelvin":for(var e=[],u=t.minTemperature,o=t.maxTemperature,l=o-u,s=u,c=0;s<o;s+=l/8,c+=1){var a=V.kelvinToRgb(s),f=a.r,h=a.g,v=a.b;e.push([12.5*c,"rgb("+f+","+h+","+v+")"])}return e;case"hue":return[[0,"#f00"],[16.666,"#ff0"],[33.333,"#0f0"],[50,"#0ff"],[66.666,"#00f"],[83.333,"#f0f"],[100,"#f00"]];case"saturation":var d=V.hsvToHsl({h:i.h,s:0,v:i.v}),g=V.hsvToHsl({h:i.h,s:100,v:i.v});return[[0,"hsl("+d.h+","+d.s+"%,"+d.l+"%)"],[100,"hsl("+g.h+","+g.s+"%,"+g.l+"%)"]];case"value":default:var b=V.hsvToHsl({h:i.h,s:i.s,v:100});return[[0,"#000"],[100,"hsl("+b.h+","+b.s+"%,"+b.l+"%)"]]}}(e,u);return h(gt,Object.assign({},e,{onInput:function(t,n,i){var r=function(t,n,i){var r,e=X(t),u=e.handleRange,o=e.handleStart;r="horizontal"===t.layoutDirection?-1*i+u+o:n-o,r=Math.max(Math.min(r,u),0);var l=Math.round(100/u*r);switch(t.sliderType){case"kelvin":var s=t.minTemperature;return s+l/100*(t.maxTemperature-s);case"alpha":return l/100;case"hue":return 3.6*l;case"red":case"blue":case"green":return 2.55*l;default:return l}}(e,t,n);e.parent.inputActive=!0,u[e.sliderType]=r,e.onInput(i,e.id)}}),function(t,n,i){return h("div",Object.assign({},n,{className:"IroSlider",style:Object.assign({},{position:"relative",width:vt(r),height:vt(o),borderRadius:vt(l),background:"conic-gradient(#ccc 25%, #fff 0 50%, #ccc 0 75%, #fff 0)",backgroundSize:"8px 8px"},i)}),h("div",{className:"IroSliderGradient",style:Object.assign({},{position:"absolute",top:0,left:0,width:"100%",height:"100%",borderRadius:vt(l),background:ht("linear","horizontal"===e.layoutDirection?"to top":"to right",c)},ft(e))}),h(bt,{isActive:!0,index:u.index,r:e.handleRadius,url:e.handleSvg,props:e.handleProps,x:s.x,y:s.y}))})}function yt(e){var t=st(e),r=t.width,u=t.height,o=t.radius,l=e.colors,s=e.parent,n=e.activeIndex,c=void 0!==n&&n<e.colors.length?e.colors[n]:e.color,a=function(t,n){return[[[0,"#fff"],[100,"hsl("+n.hue+",100%,50%)"]],[[0,"rgba(0,0,0,0)"],[100,"#000"]]]}(0,c),f=l.map(function(t){return function(t,n){var i=st(t),r=i.width,e=i.height,u=i.radius,o=n.hsv,l=u,s=r-2*u,c=e-2*u;return{x:l+o.s/100*s,y:l+(c-o.v/100*c)}}(e,t)});return h(gt,Object.assign({},e,{onInput:function(t,n,i){if(0===i){var r=at(e,t,n,f);null!==r?s.setActiveColor(r):(s.inputActive=!0,c.hsv=ct(e,t,n),e.onInput(i,e.id))}else 1===i&&(s.inputActive=!0,c.hsv=ct(e,t,n));e.onInput(i,e.id)}}),function(t,n,i){return h("div",Object.assign({},n,{className:"IroBox",style:Object.assign({},{width:vt(r),height:vt(u),position:"relative"},i)}),h("div",{className:"IroBox",style:Object.assign({},{width:"100%",height:"100%",borderRadius:vt(o)},ft(e),{background:ht("linear","to bottom",a[1])+","+ht("linear","to right",a[0])})}),l.filter(function(t){return t!==c}).map(function(t){return h(bt,{isActive:!1,index:t.index,fill:t.hslString,r:e.handleRadius,url:e.handleSvg,props:e.handleProps,x:f[t.index].x,y:f[t.index].y})}),h(bt,{isActive:!0,index:c.index,fill:c.hslString,r:e.activeHandleRadius||e.handleRadius,url:e.handleSvg,props:e.handleProps,x:f[c.index].x,y:f[c.index].y}))})}bt.defaultProps={fill:"none",x:0,y:0,r:8,url:null,props:{x:0,y:0}},pt.defaultProps=Object.assign({},{sliderShape:"bar",sliderType:"value",minTemperature:2200,maxTemperature:11e3});function wt(e){var r=ut(e).width,u=e.colors,o=(e.borderWidth,e.parent),l=e.color,s=l.hsv,c=u.map(function(t){return function(t,n){var i=n.hsv,r=ut(t),e=r.cx,u=r.cy,o=et(t),l=(180+ot(t,i.h,!0))*(nt/360),s=i.s/100*o,c="clockwise"===t.wheelDirection?-1:1;return{x:e+s*Math.cos(l)*c,y:u+s*Math.sin(l)*c}}(e,t)}),a={position:"absolute",top:0,left:0,width:"100%",height:"100%",borderRadius:"50%",boxSizing:"border-box"};return h(gt,Object.assign({},e,{onInput:function(t,n,i){if(0===i){if(!function(t,n,i){var r=ut(t),e=r.cx,u=r.cy,o=t.width/2;return rt(e-n,u-i)<o}(e,t,n))return!1;var r=at(e,t,n,c);null!==r?o.setActiveColor(r):(o.inputActive=!0,l.hsv=lt(e,t,n),e.onInput(i,e.id))}else 1===i&&(o.inputActive=!0,l.hsv=lt(e,t,n));e.onInput(i,e.id)}}),function(t,n,i){return h("div",Object.assign({},n,{className:"IroWheel",style:Object.assign({},{width:vt(r),height:vt(r),position:"relative"},i)}),h("div",{className:"IroWheelHue",style:Object.assign({},a,{transform:"rotateZ("+(e.wheelAngle+90)+"deg)",background:"clockwise"===e.wheelDirection?"conic-gradient(red, yellow, lime, aqua, blue, magenta, red)":"conic-gradient(red, magenta, blue, aqua, lime, yellow, red)"})}),h("div",{className:"IroWheelSaturation",style:Object.assign({},a,{background:"radial-gradient(circle closest-side, #fff, transparent)"})}),e.wheelLightness&&h("div",{className:"IroWheelLightness",style:Object.assign({},a,{background:"#000",opacity:1-s.v/100})}),h("div",{className:"IroWheelBorder",style:Object.assign({},a,ft(e))}),u.filter(function(t){return t!==l}).map(function(t){return h(bt,{isActive:!1,index:t.index,fill:t.hslString,r:e.handleRadius,url:e.handleSvg,props:e.handleProps,x:c[t.index].x,y:c[t.index].y})}),h(bt,{isActive:!0,index:l.index,fill:l.hslString,r:e.activeHandleRadius||e.handleRadius,url:e.handleSvg,props:e.handleProps,x:c[l.index].x,y:c[l.index].y}))})}var kt=function(i){function t(t){var n=this;i.call(this,t),this.colors=[],this.inputActive=!1,this.events={},this.activeEvents={},this.deferredEvents={},this.id=t.id,(0<t.colors.length?t.colors:[t.color]).forEach(function(t){return n.addColor(t)}),this.setActiveColor(0),this.state=Object.assign({},t,{color:this.color,colors:this.colors,layout:t.layout})}return i&&(t.__proto__=i),((t.prototype=Object.create(i&&i.prototype)).constructor=t).prototype.addColor=function(t,n){void 0===n&&(n=this.colors.length);var i=new V(t,this.onColorChange.bind(this));this.colors.splice(n,0,i),this.colors.forEach(function(t,n){return t.index=n}),this.state&&this.setState({colors:this.colors}),this.deferredEmit("color:init",i)},t.prototype.removeColor=function(t){var n=this.colors.splice(t,1)[0];n.unbind(),this.colors.forEach(function(t,n){return t.index=n}),this.state&&this.setState({colors:this.colors}),n.index===this.color.index&&this.setActiveColor(0),this.emit("color:remove",n)},t.prototype.setActiveColor=function(t){this.color=this.colors[t],this.state&&this.setState({color:this.color}),this.emit("color:setActive",this.color)},t.prototype.setColors=function(t,n){var i=this;void 0===n&&(n=0),this.colors.forEach(function(t){return t.unbind()}),this.colors=[],t.forEach(function(t){return i.addColor(t)}),this.setActiveColor(n),this.emit("color:setAll",this.colors)},t.prototype.on=function(t,n){var i=this,r=this.events;(Array.isArray(t)?t:[t]).forEach(function(t){(r[t]||(r[t]=[])).push(n),i.deferredEvents[t]&&(i.deferredEvents[t].forEach(function(t){n.apply(null,t)}),i.deferredEvents[t]=[])})},t.prototype.off=function(t,i){var r=this;(Array.isArray(t)?t:[t]).forEach(function(t){var n=r.events[t];n&&n.splice(n.indexOf(i),1)})},t.prototype.emit=function(t){for(var n=this,i=[],r=arguments.length-1;0<r--;)i[r]=arguments[r+1];var e=this.activeEvents;!!e.hasOwnProperty(t)&&e[t]||(e[t]=!0,(this.events[t]||[]).forEach(function(t){return t.apply(n,i)}),e[t]=!1)},t.prototype.deferredEmit=function(t){for(var n,i=[],r=arguments.length-1;0<r--;)i[r]=arguments[r+1];var e=this.deferredEvents;(n=this).emit.apply(n,[t].concat(i)),(e[t]||(e[t]=[])).push(i)},t.prototype.setOptions=function(t){this.setState(t)},t.prototype.resize=function(t){this.setOptions({width:t})},t.prototype.reset=function(){this.colors.forEach(function(t){return t.reset()}),this.setState({colors:this.colors})},t.prototype.onMount=function(t){this.el=t,this.deferredEmit("mount",this)},t.prototype.onColorChange=function(t,n){this.setState({color:this.color}),this.inputActive&&(this.inputActive=!1,this.emit("input:change",t,n)),this.emit("color:change",t,n)},t.prototype.emitInputEvent=function(t,n){0===t?this.emit("input:start",this.color,n):1===t?this.emit("input:move",this.color,n):2===t&&this.emit("input:end",this.color,n)},t.prototype.render=function(t,e){var u=this,n=e.layout;return Array.isArray(n)||(n=[{component:wt},{component:pt}],e.transparency&&n.push({component:pt,options:{sliderType:"alpha"}})),h("div",{class:"IroColorPicker",id:e.id,style:{display:e.display}},n.map(function(t,n){var i=t.component,r=t.options;return h(i,Object.assign({},e,r,{ref:void 0,onInput:u.emitInputEvent.bind(u),parent:u,index:n}))}))},t}(I);kt.defaultProps=Object.assign({},{width:300,height:300,color:"#fff",colors:[],padding:6,layoutDirection:"vertical",borderColor:"#fff",borderWidth:0,handleRadius:8,activeHandleRadius:null,handleSvg:null,handleProps:{x:0,y:0},wheelLightness:!0,wheelAngle:0,wheelDirection:"anticlockwise",sliderSize:null,sliderMargin:12,boxHeight:null},{colors:[],display:"block",id:null,layout:"default",margin:null});var mt,xt,jt,Mt,Ot=(It.prototype=(mt=kt).prototype,Object.assign(It,mt),It.I=mt,It);function It(n,t){var i,r=document.createElement("div");function e(){var t=n instanceof Element?n:document.querySelector(n);t.appendChild(i.base),i.onMount(t)}return function(t,n,i){var r,e,u;m.i&&m.i(t,n),e=(r=i===o)?null:i&&i.n||n.n,t=h(O,null,[t]),u=[],k(n,r?n.n=t:(i||n).n=t,e||x,x,void 0!==n.ownerSVGElement,i&&!r?[i]:e?null:j.slice.call(n.childNodes),u,!1,i||x,r),d(u,t)}(h(mt,Object.assign({},{ref:function(t){return i=t}},t)),r),"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e),i}return(jt=xt=xt||{}).version="5.5.2",jt.Color=V,jt.ColorPicker=Ot,(Mt=jt.ui||(jt.ui={})).h=h,Mt.ComponentBase=gt,Mt.Handle=bt,Mt.Slider=pt,Mt.Wheel=wt,Mt.Box=yt,xt});
        </script>
    <script>
        var rgbString;
        var rgbArray = new Uint8Array([0,0,0]);
        var cp = new iro.ColorPicker("#cp-ctnr", {
            sliderMargin: 10,
            sliderHeight: 50,
            markerRadius: 5,
            wheelLightness: false,
            color: "#FFFFFF",
            layoutDirection: "horizontal",
            width: 260,
            layout: [
                { 
                component: iro.ui.Wheel,
                }
            ]
        });
        
        cp.on("color:change", function(color, changes) {
            rgbString = color.hexString;
            //console.log(rgbString);
            rgbArray = new Uint8Array([color.red, color.green, color.blue]);
            //writeArrayCharacteristic(RgbLedCharacteristic, rgbArray);
            setSingleColourChase();
        });
    </script>
</head> 
<body onload="startConnection()">
    <div class="topnav">
        <p style="margin:10px 2px 2px 2px;"><strong><span id="bleState" style="color:#d13a30;">Disconnected</span></strong></p>
    </div>
    <div class="content">
        <div class="card-grid">
            <div class="card">
                <div >
                    <button id="homeButton" class="homeButton menu"></button>
                    <button id="logButton" class="logButton menu">Log</button>
                    <button id="reloadButton" class="reloadButton menu"></button>
                    <button id="settingsButton" class="settingsButton menu" onClick="settingsClicked()"></button>
                    <button id="connectHButton" class="connectButton menu">H</button>
                    <button id="connectBleButton" class="disconnectButton menu" style="background-color: #24af37;"></button>
                    <button id="disconnectBleButton" class="disconnectButton menu"></button>
                </div>
                <p class="gray-label"><span id="statusBar">&nbsp;</span></p>
                <div id="logPanel" style="display:none;" >
                    <p class="log-label"><span id="log"></span></p>
                </div>
            </div>
        </div>
        <div class="main-grid" id="mainGrid">
            <div class="card" style="width: 340px; height: 330px; padding-top: 20px; display: inline-block;">
                <div class="cp-grid">
                    <div id="cp-ctnr"></div>
                    <div>
                        <input  id="master" type="range" class="fader" min="0" max="255" value="0"  oninput="changeMaster(this.value)">
                    </div>
                </div>
                <div class="box-grid">
                    <div id="colourBox1" class="colourBox" onclick="setColourBox(1)"></div>
                    <div id="colourBox2" class="colourBox" onclick="setColourBox(2)"></div>
                    <div id="colourBox3" class="colourBox" onclick="setColourBox(3)"></div>
                    <div id="colourBox4" class="colourBox" onclick="setColourBox(4)"></div>
                    <div class="small-label" >
                        Fade BPM
                        <input type="text" id="colourStepTime" class="numberBox" >
                    </div>
                    <div style="height:40px; padding-top: 18px;">
                        <button id="setColourChase" class="offButton" onclick="setColourChase()">Set</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div style="width:220px; display: inline-block; ">
                    <div style="text-align: center; ">
                        <p class="reading"><span id="bpmReading">---</span> BPM <span id="testVal"> </span></p>
                    </div>
                    <div class="sliderback">
                        <div id="slider" class="slider" >
                            <!--<h1 id="knob" style="padding-left:100px">slider</h1>-->
                            <div id="knob" class="knobblock">
                                <div class="knob" ></div><div class="knob" ></div><div class="knob" ></div><div class="knob" ></div><div class="knob" ></div><div class="knob" ></div><div class="knob" ></div><div class="knob" ></div><div class="knob" ></div><div class="knob" ></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="width:100px; display: inline-block; color:white; font-size: 0.6em; margin: 0px; padding: 0px;">
                    <div>UP<input id="upTime" type="range" min="0" max="255" value="0" class="level" oninput="changeUpTime(this.value)"></div>
                    <div>ON<input id="onTime" type="range" min="0" max="255" value="0" class="level" oninput="changeOnTime(this.value)"></div>
                    <div>DN<input id="downTime" type="range" min="0" max="255" value="00" class="level" oninput="changeDownTime(this.value)"></div>
                </div>
            </div>
    </div>
    <div class="card-grid" id="settingsGrid" style="display:none">
        <div class="card">
            <h2>Settings</h2>
            <button id="onButton" class="onButton">LOG</button>
            <button id="offButton" class="offButton">OFF</button>
            <button id="testButton" class="testButton">TEST</button>
            <button id="hideButton" class="testButton" onclick="sendHide(1)">HIDE</button>
            <button id="showButton" class="testButton" onclick="sendHide(0)">SHOW</button>
            <p>
                <p class="gray-label">
                Search name: <input type="text" id="searchBox">
                </p>
                <select id="devicesSelect"></select>
                <button id="forgetBluetoothDevice" class="offButton">Forget Device</button>
                </p>
                <p>
                <input type="text" id="nameBox">
                <button id="setName" class="offButton" onclick="setDeviceName()">Set Device Name</button>
                </p>
                <p class="gray-label">
                Arrival Flash - 
                On<input type="text" id="arrivalOnBox" class="numberBox">
                Dwell<input type="text" id="arrivalDwellBox" class="numberBox">
                </p>
                <p class="gray-label">
                Charge Indication - 
                On<input type="text" id="chargeLEDonBox" class="numberBox">
                Bright<input type="text" id="chargeLEDbrightBox" class="numberBox">
                </p><p>
                <button id="setArrival" class="offButton" onclick="setSettings()">Set</button>
                </p>
        </div>
    </div>

    <div class="card-grid" id="logGrid" style="display:none">
        <div class="card">
            <h2>Devices</h2>
            <div id="rssiChart">
                <canvas id="chartCanvas" width="300" height="100" class="chartCanvas" style="display: none;"></canvas>
            </div>
            <div id="deviceLog">
                <div class="log-device" style="color: #5f6c6d;">
                    <div class="log-name" >Name</div>
                    <div class="log-item" style="width: 35px">Seen</div><div class="log-item">Batt</div><div class="log-item">Sig</div><div class="log-item">Stat</div>
                </div>
                <ul id="logList" class="log-device"></ul>
            </div>
        </div>
    </div>
    
</body>
<script>
    // DOM Elements
    const connectButton = document.getElementById('connectBleButton');
    const connectHButton = document.getElementById('connectHButton');
    const disconnectButton = document.getElementById('disconnectBleButton');
    const onButton = document.getElementById('onButton');
    const offButton = document.getElementById('offButton');
    const testButton = document.getElementById('testButton');
    const retrievedValue = document.getElementById('valueContainer');
    const bleStateContainer = document.getElementById('bleState');
    const timestampContainer = document.getElementById('timestamp');
    const reconnectButton = document.getElementById('reconnectBleButton');
    const logContainer = document.getElementById('log');
    const logPanel = document.getElementById('logPanel');
    const logButton = document.getElementById('logButton');
    const homeButton = document.getElementById('homeButton');
    const bpmSlider = document.getElementById('bpmSlider');
    const bpmReading = document.getElementById('bpmReading');
    const slider = document.getElementById("slider");
    const knob = document.getElementById("knob");
    const bpmIndicator = document.getElementById("bpmReading");
    const forgetButton = document.getElementById("forgetBluetoothDevice");
    const setNameBox = document.getElementById("nameBox");
    const upTimeRange = document.getElementById("upTime");
    const onTimeRange = document.getElementById("onTime");
    const downTimeRange = document.getElementById("downTime");
    const arrivalOnBox = document.getElementById("arrivalOnBox");
    const arrivalDwellBox = document.getElementById("arrivalDwellBox");
    const chargeLEDonBox = document.getElementById("chargeLEDonBox");
    const chargeLEDbrightBox = document.getElementById("chargeLEDbrightBox");
    const colourStepTime = document.getElementById("colourStepTime");
    const master = document.getElementById("master");
    const settingsButton = document.getElementById("settingsButton");
    const statusBar = document.getElementById("statusBar");
    const logList = document.getElementById("logList");
    const chartCanvas = document.getElementById("chartCanvas");
    const searchBox = document.getElementById("searchBox");
    const reloadButton = document.getElementById("reloadButton");

    // RSSI chart 
    const ctx = chartCanvas.getContext("2d");
    ctx.transform(3, 0, 0, -1, 0, chartCanvas.height);
    
    
    var bpmValue = 60;
    var mousedown = false;
    var sliderX = 0;
    var mouseX = 0;
    var bpmValue = 60;
    var colChase
    var chaseArray = new Uint8Array (20);
    var colourArray = new Uint8Array (20);

    //Define BLE Device Specs
    var deviceNamePrefix = 'ShroomLight-';

    var bleService = '25594900-444a-46ee-9b93-0296c3ae54ec'; 
    //var ledCharacteristic = '25594902-444a-46ee-9b93-0296c3ae54ec'; 
    var sensorCharacteristic = '25594901-444a-46ee-9b93-0296c3ae54ec'; 
    var StatusCharacteristic = '25594903-444a-46ee-9b93-0296c3ae54ec';
    var RateCharacteristic = '25594904-444a-46ee-9b93-0296c3ae54ec';
    var NameCharacteristic = '25594905-444a-46ee-9b93-0296c3ae54ec';
    var SettingsCharacteristic = '25594906-444a-46ee-9b93-0296c3ae54ec';

    var rateChar;

    //Global Variables to Handle Bluetooth
    var bleServer;
    var bleServiceFound;
    var sensorCharacteristicFound;
    var deviceConnectionStarted = false;
    var bluetoothChecker;

    function settingsClicked() {
        document.getElementById("mainGrid").style.display = "none";
        document.getElementById("settingsGrid").style.display = "block";
        document.getElementById("logGrid").style.display = "none";
    }

    // Connect Button (search for BLE Devices only if BLE is available)
    connectButton.addEventListener('click', (event) => {
        if (isWebBluetoothEnabled()){
            connectToDevice();
        }
    });

    connectHButton.addEventListener('click', (event) => {
        searchBox.value = "H";
        if (isWebBluetoothEnabled()){
            connectToDevice();
        }
    });

    // Disconnect Button
    disconnectButton.addEventListener('click', disconnectDevice);

    // Home button
    homeButton.addEventListener('click', (event) => {
        document.getElementById("mainGrid").style.display = "block";
        document.getElementById("logGrid").style.display = "none";
        document.getElementById("settingsGrid").style.display = "none";
    });

    logButton.addEventListener('click', (event) => {
        requestLogSummary();
        document.getElementById("mainGrid").style.display = "none";
        document.getElementById("logGrid").style.display = "block";
        document.getElementById("settingsGrid").style.display = "none";
    });

    reloadButton.addEventListener('click', (event) => {
        disconnectDevice();
        setTimeout(function() {window.location.reload();}, 500);
        
    });

    // Write to the ESP32 LED Characteristic
    onButton.addEventListener('click', () => test(3));
    offButton.addEventListener('click', () => shutdown());
    //testButton.addEventListener('click', () => test(1));
    testButton.addEventListener('click', () => checkTest());
    forgetButton.addEventListener('click', () => onForgetBluetoothDeviceButtonClick());



    function onForgetBluetoothDeviceButtonClick() {
        statusLog("Forget device")
    navigator.bluetooth.getDevices()
    .then(devices => {
        const deviceIdToForget = document.querySelector('#devicesSelect').value;
        const device = devices.find((device) => device.id == deviceIdToForget);
        if (!device) {
        throw new Error('No Bluetooth device to forget');
        }
        statusLog('Forgetting ' + device.name);
        return device.forget();
    })
    .then(() => {
        statusLog('  > Bluetooth device has been forgotten.');
        //populateBluetoothDevices();
    })
    .catch(error => {
        statusLog('Argh! ' + error);
    });
    }



    // Check if BLE is available in your Browser
    function isWebBluetoothEnabled() {
        if (!navigator.bluetooth) {
            console.log('Web Bluetooth API is not available in this browser!');
            bleStateContainer.innerHTML = "Web Bluetooth API is not available";
            bleStateContainer.style.color = "red";
            return false
        }
        console.log('Web Bluetooth API supported in this browser.');
        return true
    }

    function statusLog(message) {
        console.log(message);
        logContainer.innerHTML += message;
        logContainer.innerHTML += "<br/>";
    }

    var bleDevice;
    //var abortController;
    var abortControllers = new Array();

    // Onload, start by trying to connect to existing device
    async function startConnection() {
        statusLog("start");
        
        bleDevice = null;
        deviceConnectionStarted = false;
        bleStateContainer.innerHTML = 'Connecting...';
        bleStateContainer.style.color = "#d66a1c";
        if (!isWebBluetoothEnabled()){ return; }
        statusLog("Check for existing devices");
        let devices;
        try {
            devices = await navigator.bluetooth.getDevices();
        } catch {
            statusLog("getDevices not enabled");
            // Need to enable chrome://flags "Use the new permissions backend for Web Bluetooth"
            return;
        }
        statusLog('> Got ' + devices.length + ' Bluetooth devices.');
        if(devices.length > 0) {
            statusLog("Start scanning");
            const scanTimeout = setTimeout(scanTimeoutElapsed, 5000);
            for (let device of devices) {
                statusLog("Scan for: " + device.name + " - " + device.id);
                //Add device to remove list8
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = device.name;
                devicesSelect.appendChild(option);
                // Start a scan for each device before connecting to check that they're in range.
                let abortController = new AbortController();
                abortControllers.push(abortController);
                await device.watchAdvertisements({signal: abortController.signal});
                device.addEventListener('advertisementreceived', async (evt) => {
                    // Stop the scan to conserve power on mobile devices.
                    abortController.abort();
                    clearTimeout(scanTimeout);
                    statusLog("Listener added: " + device.name);
                    if (bleDevice == null) {
                        bleDevice = device;
                    }
                });
                device.addEventListener('advertisementreceived', connectToService);
            }
        } else {
            scanTimeoutElapsed();
        }
    }

    function scanTimeoutElapsed() {
        abortControllers.forEach(abortScan);
        statusLog("Timeout");
        bleStateContainer.innerHTML = 'Press Connect button';
        bleStateContainer.style.color = "#d13a30";
    }

    function abortScan(abortController, index) {
        try {
            abortController.abort();        // Just in case it's still running
        } catch {}
    }

    // Manually connect to BLE Device 
    async function connectToDevice(){
        // try {
            statusLog('Initializing Bluetooth...');
            deviceConnectionStarted = false;
            bleDevice = null;
            try {
                abortController.abort();        // Just in case it's still running
            } catch {}
            let searchterm = deviceNamePrefix + searchBox.value;
            console.log("Search for:", searchterm);
            bleDevice = await navigator.bluetooth.requestDevice({ filters: [{namePrefix: searchterm}], optionalServices: [bleService] });
            //bleDevice = await navigator.bluetooth.requestDevice({acceptAllDevices:true});
            statusLog('Device Selected:', bleDevice.name);
            bleStateContainer.innerHTML = 'Connecting...';
            bleStateContainer.style.color = "#d66a1c";
            bleDevice.addEventListener('gattservicedisconnected', onDisconnected);
            await connectToService();
/*          } catch(error) {
            statusLog('Error: ', error);
        } */
    }

    // Device found, connect to charactertistics
    async function connectToService() {
        if (deviceConnectionStarted) {return;}      // Only connect to the first device found
        deviceConnectionStarted = true;
        try {
            bleServer = await bleDevice.gatt.connect();
            statusLog("Connected to GATT Server");
            const service = await bleServer.getPrimaryService(bleService);
            bleServiceFound = service;
            statusLog("Service discovered:" + service.uuid);
            if(bleDevice == null) {
                bleStateContainer.innerHTML = 'Connected';
            } else {
                bleStateContainer.innerHTML = bleDevice.name;
                setNameBox.value = bleDevice.name.replace(deviceNamePrefix, "");
            }
            bluetoothChecker = setInterval(checkBluetooth,2000);
            bleStateContainer.style.color = "#24af37";
            const characteristics = await service.getCharacteristics();
            for(const characteristic of characteristics) {
                //console.log("Characteristic discovered:" + characteristic.uuid);
                // Throws an error on Android if you do more than one startNotifications or readValue in this loop.
                switch(characteristic.uuid) {
                    case sensorCharacteristic:
                        sensorCharacteristicFound = characteristic;
                        characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicChange);
                        await characteristic.startNotifications();
                        // This works, but since it calls the callback anyway there is no need.
                        await characteristic.readValue().then(value => {
                            //console.log("Read value: ", value);
                            const decodedValue = new TextDecoder().decode(value);
                            //console.log("Decoded value: ", decodedValue);
                        })
                    break;
                    case RateCharacteristic:
                        //console.log("RateCharacteristic");
                        characteristic.addEventListener('characteristicvaluechanged', handleRateChange);
                        await characteristic.startNotifications();
                        // If there is a callback for this characteristic, there is no need to wait for the response here.
                        await characteristic.readValue();  
                    break;
                    case SettingsCharacteristic:
                        //console.log("SettingsCharacteristic");
                        characteristic.addEventListener('characteristicvaluechanged', handleSettingsChange);
                        await characteristic.startNotifications();
                        // If there is a callback for this characteristic, there is no need to wait for the response here.
                        await characteristic.readValue();  
                    break;
                    case StatusCharacteristic:
                        //console.log("StatusCharacteristic");
                        characteristic.addEventListener('characteristicvaluechanged', handleStatusChange);
                        await characteristic.startNotifications(); 
                    break;
                    case NameCharacteristic:
                        break;
                    default: console.log("Unknown characteristic: " + characteristic.uuid);
                }
            }
        } catch(error) {
            console.log('Error: ', error);
            bleStateContainer.innerHTML = 'Press Connect button';
            bleStateContainer.style.color = "#d13a30";
        }
    }

    function onDisconnected(event){
        console.log('Device Disconnected:', event.target.device.name);
        bleStateContainer.innerHTML = "Disconnected";
        bleStateContainer.style.color = "#d13a30";

        connectToDevice();
    }

    function handleCharacteristicChange(event){
        const newValueReceived = new TextDecoder().decode(event.target.value);
        //retrievedValue.innerHTML = newValueReceived;
        //timestampContainer.innerHTML = getDateTime();
    }

    // Callback from RateCharacteristic
    function handleRateChange(event){
        updateRate(event.target.value);
    }
    function updateRate(value) {
        const uintArr = new Uint8Array(value.buffer);
        chaseArray = uintArr.slice();
        colourArray = uintArr.slice();
        const mBPM = uintArr[0];
        upTimeRange.value = uintArr[1];
        onTimeRange.value = uintArr[2];
        downTimeRange.value = uintArr[3];
        bpmValue = mBPM * 4;
        bpmIndicator.innerHTML = mBPM;
        master.value = uintArr[4];
        colourStepTime.value = uintArr[5];
        //fade% = uintArr[6];
        let steps = uintArr[7];
        for ( i = 0; i < 4; i++) {
            let box = document.getElementById("colourBox" + (i + 1));
            //console.log(i + " " + (uintArr[8+(i*3)] + uintArr[9+(i*3)] + uintArr[10+(i*3)]));
            if(uintArr[8+(i*3)] + uintArr[9+(i*3)] + uintArr[10+(i*3)] == 0) {
                box.style.backgroundColor = "";
            } else {
                box.style.backgroundColor = "rgb(" + uintArr[8+(i*3)] + "," + uintArr[9+(i*3)] + "," + uintArr[10+(i*3)] + ")";
            }
        }
    }

    //Callback from SettingsCharacteristic
    function handleSettingsChange(event){
        //console.log("Settings changed");
        const uintArr = new Uint8Array(event.target.value.buffer);
        arrivalDwellBox.value = uintArr[0];
        arrivalOnBox.value = uintArr[1]; 
        chargeLEDonBox.value = uintArr[2];
        chargeLEDbrightBox.value = uintArr[3];
    }

    function test(req) {
        //Max array size is 512 bytes
        const uintArr = new Uint8Array(4);
        uintArr[0] = 3;
        uintArr[1] = req;
        uintArr[2] = 1;
        uintArr[3] = 4;
        writeArrayCharacteristic(StatusCharacteristic, uintArr);
    }

    function requestLogSummary() {
        const uintArr = new Uint8Array(4);
        uintArr[0] = 3;
        uintArr[1] = 1;
        uintArr[2] = 1;
        uintArr[3] = 4;
        writeArrayCharacteristic(StatusCharacteristic, uintArr);
    }

    function requestDeviceDetails(id) {
        const uintArr = new Uint8Array(4);
        uintArr[0] = 3;
        uintArr[1] = 3;
        uintArr[2] = id;
        uintArr[3] = 4;
        writeArrayCharacteristic(StatusCharacteristic, uintArr);
    }

    function sendHide(hide) {
        if(hide > 0) {
            if(!confirm("Stop WiFi Broadcast?")) {return;}
        }
        const uintArr = new Uint8Array(4);
        uintArr[0] = 3;
        uintArr[1] = 5;
        uintArr[2] = hide;
        uintArr[3] = 4;
        writeArrayCharacteristic(StatusCharacteristic, uintArr);
    }

    function shutdown() {
        if(confirm("Shutdown the light?")) {
            test(4);
        }
    }

    const DEVICE_LOG_SIZE = 100;
    const DEVICE_NAME_LENGTH = 32;
    const LOG_SUMMARY_ITEM_COUNT = 20;
    const LOG_SUMMARY_ITEM_LENGTH = 20;

    const dev = {
        id: 0,
        mac: [0],
        timeSinceBoot: 0,
        lastContact: 0,
        status: 0,
        lastUI: 0,
        battery: 0,
        name: "",
        signal: [0],
        curSignal: 0
    }

    var logs;
    var devices = new Array(LOG_SUMMARY_ITEM_COUNT);
    var logDisplay = new Map();

    //Callback from statusCharacteristic
    function handleStatusChange(event){
        //console.log("Status changed");
        const uintArr = new Uint8Array(event.target.value.buffer);
        //console.log(uintArr);
        if(uintArr[0] == 3 && uintArr[3] == 4) {
            switch(uintArr[1]) {
                case 1:     // Log
                    //console.log(uintArr);
                    readLogSummary(event.target.value.buffer);
                    break;
                case 2:     // Status
                    //console.log("Battery:" + uintArr[4]);
                    statusBar.innerHTML = "Battery: " + uintArr[4] + "% " + (uintArr[5] ? "Charging" : "");
                    break;
                case 3:     // Log
                    readLogDetail(event.target.value.buffer);
                    break;
                default:
            }
        }
    }

    function readLogSummary(buffer) {
        logs = new Array();
        //logList.innerHTML = "";
        let ls = new DataView(buffer);
        let timestamp = ls.getUint32(4, true);
        for (i = 0; i < LOG_SUMMARY_ITEM_COUNT; i++) {
            let lg = buffer.slice( i * LOG_SUMMARY_ITEM_LENGTH + 8,  (i + 1) * LOG_SUMMARY_ITEM_LENGTH + 8)
            let dv = new DataView(lg);
            const log = {
                id: dv.getUint8(0),
                mac: toHexString(new Uint8Array(lg.slice(1,7))),
                lastContact: dv.getUint32(8, true),
                lastUI: dv.getUint32(12, true),
                status: dv.getUint8(16),
                battery: dv.getUint8(17),
                signal: dv.getUint8(18)
            }
            logs.push(log);
            if (log.id > 0) {                                          // We have a device
                displayLogEntry(log, timestamp);
            }
        }
        //console.log(timestamp, logs);
    }

    function displayLogEntry(log, timestamp) {
        const listItem = logDisplay.get(log.id);
        //console.log(log.id, listItem);
        //console.log(logDisplay);
        if(listItem == null) {
            //console.log("create log");
            createLogEntry(log, timestamp);
        } else {
            //console.log("update log");
            updateLogEntry(listItem, log, timestamp);
        }
    }

    function updateLogEntry(listItem, log, timestamp) {
        //const divName = document.getElementById("itemName" + log.id);
        const coll = listItem.childNodes;
        //console.log(coll);
        const divContact= coll[1];
        const divBatt = coll[2];
        const divSignal = coll[3];
        const divStatus = coll[4];
        let tm = timestamp - log.lastContact;
        divContact.innerText = new Date(tm * 1000).toISOString().substring(14, 19)
        if(tm < 10) {divContact.setAttribute("style", "background-color: green; width:35px")}
        divBatt.innerText = log.battery;
        if(log.battery < 30) { divBatt.setAttribute("style", "background-color: red");}
        if(log.battery > 80) { divBatt.setAttribute("style", "background-color: green");}
        divSignal.innerText = log.signal;
        let stat = "";
        if(log.status & 1) { 
            divStatus.setAttribute("style", "background-color: green");
            stat += "I";
        }
        if(log.status & 2) { stat += "A"}
        if(log.status & 4) { stat += "R"}
        if(selectedDevice == log.id) {
            requestDeviceDetails(log.id);
        }
    }
        
    function createLogEntry(log, timestamp) {
        const listItem = document.createElement("li");
        listItem.setAttribute("id", "device" + log.id);
        listItem.setAttribute("class", "log-listitem");
        listItem.setAttribute("onClick", "deviceClicked(" + log.id + ")");
        //listItem.innerText = log.mac;
        //const divMac = document.createElement("div");
        const divName = document.createElement("div");
        const divContact= document.createElement("div");
        const divSignal = document.createElement("div");
        const divBatt = document.createElement("div");
        const divStatus = document.createElement("div");
        divName.setAttribute("id", "itemName" + log.id);
        divName.setAttribute("class", "log-name");
        divName.innerText = "xxxx";
        listItem.appendChild(divName)
        //divMac.setAttribute("id", "itemMac" + log.id);
        //divMac.setAttribute("class", "log-item");
        //divMac.innerText = log.mac;
        //listItem.appendChild(divMac)
        divContact.setAttribute("id", "itemContact" + log.id);
        divContact.setAttribute("class", "log-item");
        divContact.setAttribute("style", "width:35px");
        let tm = timestamp - log.lastContact;
        divContact.innerText = new Date(tm * 1000).toISOString().substring(14, 19)
        if(tm < 10) {divContact.setAttribute("style", "background-color: green; width:35px")}
        listItem.appendChild(divContact);
        divBatt.setAttribute("id", "itemBatt" + log.id);
        divBatt.setAttribute("class", "log-item");
        divBatt.innerText = log.battery;
        if(log.battery < 30) { divBatt.setAttribute("style", "background-color: red");}
        if(log.battery > 80) { divBatt.setAttribute("style", "background-color: green");}
        listItem.appendChild(divBatt);
        divSignal.setAttribute("id", "itemSignal" + log.id);
        divSignal.setAttribute("class", "log-item");
        divSignal.innerText = log.signal;
        listItem.appendChild(divSignal);
        divStatus.setAttribute("id", "itemStatus" + log.id);
        divStatus.setAttribute("class", "log-item");
        let stat = "";
        if(log.status & 1) { 
            divStatus.setAttribute("style", "background-color: green");
            stat += "I";
        }
        if(log.status & 2) { stat += "A"}
        if(log.status & 4) { stat += "R"}
        //divStatus.innerText = log.status;
        divStatus.innerText = stat;
        listItem.appendChild(divStatus);
        logList.appendChild(listItem);
        logDisplay.set(log.id, listItem);
        if(devices[log.id] == null) {
            requestDeviceDetails(log.id)
        }
        else {
            const nameTag = document.getElementById("itemName" + dev.id);
            if(nameTag != null) {
                nameTag.innerText = dev.name;
            }
        }
    }

    var selectedDevice = 0;

    function deviceClicked(id) {
        const list = document.getElementsByClassName("log-listitem-Selected");
        const listItem = document.getElementById("device" + id);
        for (let i = 0; i < list.length; i++) {
            list[i].setAttribute("class", "log-listitem");
        }
        if(id == selectedDevice) {                                              // Clicked the selected device
            chartCanvas.setAttribute("style", "display: none");
            selectedDevice = 0;
        } else {
            listItem.setAttribute("class", "log-listitem-Selected");
            chartCanvas.setAttribute("style", "display: block");
            selectedDevice = id;
        }
    }

    function toHexString(byteArray) {
        return Array.from(byteArray, function(byte) {
            return ('0' + (byte & 0xFF).toString(16)).slice(-2);
        }).join(':')
    }

    function readLogDetail(uintArr) {
        //console.log("read detail");
        let dv = new DataView(uintArr);
        dev.mac = uintArr.slice(5, 11);
        dev.id = dv.getUint8(4);
        dev.timeSinceBoot = dv.getUint32(12,true);
        dev.lastContact = dv.getUint32(16,true);
        dev.lastUI = dv.getUint32(20,true);
        dev.status = dv.getUint8(24);
        dev.battery = dv.getUint8(25);
        const name = new TextDecoder().decode(uintArr.slice(26, 26 + DEVICE_NAME_LENGTH));
        dev.name = name.substring(0, name.indexOf('\0')).replace(deviceNamePrefix, "");
        dev.curSignal = dv.getUint8(26 + DEVICE_NAME_LENGTH)
        dev.signal = new Uint8Array(uintArr.slice(27 + DEVICE_NAME_LENGTH, 127 + DEVICE_NAME_LENGTH));
        devices[dev.id] = dev;
        const nameTag = document.getElementById("itemName" + dev.id);
        if(nameTag != null) {
            nameTag.innerText = dev.name;
        }
        //console.log(dev.signal);
        drawRSSIchart(dev.id);
    }

    function drawRSSIchart(id) {
        // Clear the chart
        ctx.save();
        ctx.setTransform(1, 0, 0, 1, 0, 0);         // Use the identity matrix while clearing the canvas
        ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);         
        ctx.restore();
        ctx.beginPath();
        let logStart = devices[id].curSignal + 1;
        let x = 0;
        if (logStart >= 100) {logStart = 0};
        ctx.moveTo(x, devices[id].signal[logStart]);
        //console.log("Crursignal:", devices[id].curSignal);
        for(i = logStart; i < 100; i++) {
            //console.log( x, i, devices[id].signal[i]);
            ctx.lineTo(x, devices[id].signal[i]);
            ctx.strokeStyle = "yellow";
            ctx.stroke();
            x++;
        }
        ctx.moveTo(x, devices[id].signal[0]);
        for(i = 0; i < logStart - 1; i++) {
            //console.log( x, i, devices[id].signal[i]);
            ctx.lineTo(x, devices[id].signal[i]);
            ctx.stroke();
            x++;
        }
    }

    var writeBusy = false;
    var queuedCharacteristic = null;
    var queuedValue = null;
    function writeArrayCharacteristic(characteristic, value){
        if (writeBusy) { 
            queuedCharacteristic = characteristic;
            queuedValue = value;
            return false;
        } 
        writeBusy = true;
        const writeTimeout = setTimeout(writeTimeoutElapsed, 500);
        if (bleServer && bleServer.connected) {
            bleServiceFound.getCharacteristic(characteristic)
            .then(characteristic => {
                //console.log("Found the Array characteristic: ", characteristic.uuid);
                return characteristic.writeValue(value);
            })
            .then(() => {
                //console.log("Value written to Array characteristic:", value);
            })
            .catch(error => {
                //console.error("Error writing to the Array characteristic: ", error);
            });
        } else {
            console.error ("Bluetooth is not connected. Cannot write to characteristic.")
            //window.alert("Bluetooth is not connected. Cannot write to characteristic. \n Connect to BLE first!")
        }
        return true;
    }

    function writeTimeoutElapsed() {
        writeBusy = false;
        if (queuedCharacteristic != null) {
            writeArrayCharacteristic(queuedCharacteristic, queuedValue);
        }
        queuedCharacteristic = null;
        queuedValue = null;
    }

    function writeStringCharacteristic(characteristic, value){
        if (bleServer && bleServer.connected) {
            bleServiceFound.getCharacteristic(characteristic)
            .then(characteristic => {
                //console.log("Found the characteristic: ", characteristic.uuid);
                //console.log("Write: ", value);
                var enc = new TextEncoder(); // always utf-8
                const data = enc.encode(value);
                return characteristic.writeValue(data);
            })
            .then(() => {
                //console.log("Value written to string characteristic:", value);
            })
            .catch(error => {
                console.error("Error writing to the string characteristic: ", error);
            });
        } else {
            console.error ("Bluetooth is not connected. Cannot write to characteristic.")
            //window.alert("Bluetooth is not connected. Cannot write to characteristic. \n Connect to BLE first!")
        }
    }

    function disconnectDevice() {
        console.log("Disconnect Device.");
        if (bleServer && bleServer.connected) {
            if (sensorCharacteristicFound) {
                sensorCharacteristicFound.stopNotifications()
                    .then(() => {
                        console.log("Notifications Stopped");
                        return bleServer.disconnect();
                    })
                    .then(() => {
                        console.log("Device Disconnected");
                        bleStateContainer.innerHTML = "Disconnected";
                        bleStateContainer.style.color = "#d13a30";
                    })
                    .catch(error => {
                        console.log("An error occurred:", error);
                    });
            } else {
                console.log("No characteristic found to disconnect.");
            }
        } else {
            // Throw an error if Bluetooth is not connected
            console.error("Bluetooth is not connected.");
            //window.alert("Bluetooth is not connected.")
        }
    }

    function checkTest() {
        setInterval(checkBluetooth,2000);
    }

    function checkBluetooth() {
        if (bleServer && bleServer.connected) {
            //console.log("Connected"); 
        } else {
            //console.log("Disconnected"); 
            bleStateContainer.innerHTML = "Disconnected";
            bleStateContainer.style.color = "#d13a30";
            clearInterval(bluetoothChecker);
        }
    }

    function getDateTime() {
        var currentdate = new Date();
        var day = ("00" + currentdate.getDate()).slice(-2); // Convert day to string and slice
        var month = ("00" + (currentdate.getMonth() + 1)).slice(-2);
        var year = currentdate.getFullYear();
        var hours = ("00" + currentdate.getHours()).slice(-2);
        var minutes = ("00" + currentdate.getMinutes()).slice(-2);
        var seconds = ("00" + currentdate.getSeconds()).slice(-2);

        var datetime = day + "/" + month + "/" + year + " at " + hours + ":" + minutes + ":" + seconds;
        return datetime;
    }


async function getPermittedBluetoothDevices() {
    console.log("Start scan");
  let devices = await navigator.bluetooth.getDevices();
  console.log('> Got ' + devices.length + ' Bluetooth devices.');
  for (let device of devices) {
    console.log("Scan for: ", device.deviceName);
    // Start a scan for each device before connecting to check that they're in range.
    let abortController = new AbortController();
    await device.watchAdvertisements({signal: abortController.signal});
    console.log("advertisementreceived");
    device.addEventListener('advertisementreceived', async (evt) => {
      // Stop the scan to conserve power on mobile devices.
      abortController.abort();

      // Advertisement data can be read from |evt|.
      let deviceName = evt.name;
      let uuids = evt.uuids;
      let appearance = evt.appearance;
      let pathloss = evt.txPower - evt.rssi;
      let manufacturerData = evt.manufacturerData;
      let serviceData = evt.serviceData;

      console.log("advertisement received", deviceName)
      // At this point, we know that the device is in range, and we can attempt to connect to it.      
    });
    device.addEventListener('advertisementreceived', reconnect2);
    return device;
  }
}

//Slider
slider.addEventListener('mousedown', (event) => {
        mousedown = true;
        mouseX = event.clientX;
    });
    slider.addEventListener('mouseup', (event) => {
        mousedown = false;
        sendBPM();
    });
    slider.addEventListener('mouseout', (event) => {
        if (mousedown) {
            sendBPM();
        }
        //mousedown = false;
    });
    slider.addEventListener('mousemove', (event) => {
        if (mousedown) {
            updateBPM(event.clientX);
        }
    });
    slider.addEventListener('touchstart', (event) => {
        mousedown = true;
        mouseX = Math.round(event.touches[0].clientX);
    });
    slider.addEventListener('touchend', (event) => {
        mousedown = false;
        sendBPM();
    });
    slider.addEventListener('touchmove', (event) => {
        updateBPM(Math.round(event.touches[0].clientX));
    });

    function sendBPM() {
        //let chaseArray = new Uint8Array ([Math.round(bpmValue /4), upTime, onTime, downTime]);
        chaseArray[0] = Math.round(bpmValue /4);
        chaseArray[1] = upTimeRange.value;
        chaseArray[2] = onTimeRange.value;
        chaseArray[3] = downTimeRange.value;
        writeArrayCharacteristic(RateCharacteristic, chaseArray);
    }

    function updateBPM(clientX) {
        //document.getElementById("testVal").innerHTML = clientX;
        let moveX = clientX - mouseX ;
        mouseX = clientX;
        sliderX+=moveX
        bpmValue+=moveX;
        if(bpmValue < 0) {
            bpmValue = 0;
            sliderX = 0;
        }
        if(bpmValue >= 960) {
            bpmValue = 960;
            sliderX = 0;
        }
        bpmIndicator.innerHTML = Math.round(bpmValue /4);
        if(sliderX >= 25 ) {
            sliderX-= 25;
        }
        if(sliderX <= -25) {
            sliderX += 25;
        }
        knob.style.left = sliderX + "px"; 
    }

    function setDeviceName() {
        const newName = setNameBox.value;
        writeStringCharacteristic(NameCharacteristic, newName);
    }

    function changeUpTime(value) {
        //upTime = value;
        sendBPM();
    }
    function changeOnTime(value) {
        //onTime = value;
        sendBPM();
    }
    function changeDownTime(value) {
        //downTime = value;
        sendBPM();
    }

    function setSettings() {
        const uintArr = new Uint8Array([arrivalDwellBox.value, arrivalOnBox.value, chargeLEDonBox.value, chargeLEDbrightBox.value]);
        writeArrayCharacteristic(SettingsCharacteristic, uintArr);
    }

    function setColourBox(num) {
        //console.log("set " + num);
        let box = document.getElementById("colourBox" + num);
        if(box.style.backgroundColor == "") { 
            box.style.backgroundColor = rgbString;
            //colourArray[4] = master.value;
            colourArray[5] = colourStepTime.value;
            colourArray[6] = 255; // Fade percentage
            //colourArray[7] = steps
            colourArray[5 + num * 3] = rgbArray[0];
            colourArray[6 + num * 3] = rgbArray[1];
            colourArray[7 + num * 3] = rgbArray[2];
        } else {
            if (num < 4) {
                let box2 = document.getElementById("colourBox" + (num + 1));
                if(box2.style.backgroundColor != "") { 
                    return;
                }
            }
            box.style.backgroundColor =  "";
            colourArray[5 + num * 3] = 0;
            colourArray[6 + num * 3] = 0;
            colourArray[7 + num * 3] = 0;
        }
        
    }


    function setColourChase() {
        for ( i = 0; i < 4; i++) {
            let box = document.getElementById("colourBox" + (i + 1));
            if(box.style.backgroundColor == "") { break;}
        }
        chaseArray[4] = master.value;
        chaseArray[5] = colourStepTime.value;
        chaseArray[6] = 255; // Fade percentage
        chaseArray[7] = i; //steps
        for( i = 8; i < chaseArray.length; i++) {
            chaseArray[i] = colourArray[i];
        }
        sendBPM();
    }

    function setSingleColourChase() {
        chaseArray[4] = master.value;
        chaseArray[5] = colourStepTime.value;
        chaseArray[6] = 255; // Fade percentage
        chaseArray[7] = 1; //steps
        chaseArray[8] = rgbArray[0];
        chaseArray[9] = rgbArray[1];
        chaseArray[10] = rgbArray[2];
        sendBPM();
    }

    function changeMaster(value) {
        chaseArray[4] = master.value;
        sendBPM();
    }


</script>

</html>